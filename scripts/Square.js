// Generated by CoffeeScript 1.6.2
define(['Crafty', 'components/Highlighter', 'ColorScheme'], function(Crafty, Highlighter, Scheme) {
  var DEG, DOWN, LEFT, LIMIT, NEXT, RIGHT, UP, key;

  key = 'Square';
  UP = 0;
  RIGHT = 1;
  DOWN = 2;
  LEFT = 3;
  LIMIT = 4;
  DEG = function(dir) {
    return dir * 90;
  };
  NEXT = function(dir) {
    return (dir + 1) % LIMIT;
  };
  Crafty.c(key, {
    init: function() {
      var size;

      size = 50;
      this.requires("2D, Tween, Canvas, Color, Mouse, " + Highlighter);
      this.attr({
        w: size,
        h: size
      });
      this.baseColor(Scheme.primary[0]);
      this.highColor(Scheme.primary[4]);
      this.origin("center");
      this.arrow = Crafty.e("2D, Canvas, Color, Tween, " + Highlighter);
      this.arrow.attr({
        w: 10,
        h: 10
      });
      this.arrow.origin(5, 25);
      this.arrow.shift(20, 0);
      this.arrow.baseColor(Scheme.secondary[0]);
      this.arrow.highColor(Scheme.secondary[4]);
      this.attach(this.arrow);
      this.bind('Click', this.Click);
      this.bind('MouseOver', this.MouseOver);
      this.bind('MouseOut', this.MouseOut);
      this.bind('MouseDown', this.MouseDown);
      return this.bind('MouseUp', this.MouseUp);
    },
    Click: function(e) {
      var next;

      if (this.ignoreClick) {
        this.ignoreClick = false;
        return;
      }
      next = NEXT(this.attr('sqdir'));
      this.attr('sqdir', next);
      this.tween({
        rotation: next === 0 ? DEG(LIMIT) : DEG(next)
      }, 15);
      this.unbind('TweenEnd', this.TweenEnd);
      return this.bind('TweenEnd', this.TweenEnd);
    },
    TweenEnd: function(e) {
      if (this.rotation === 360) {
        this.rotation = 0;
      }
      return this.unbind('TweenEnd', this.TweenEnd);
    },
    MouseOver: function(e) {
      console.log('over', e);
      this.highlight(15);
      return this.arrow.highlight(15);
    },
    MouseOut: function(e) {
      this.unhighlight(15);
      this.arrow.unhighlight(15);
      return this.endDragging();
    },
    MouseDown: function(e) {
      this.dragging = true;
      this.dragStartX = e.realX;
      this.dragStartY = e.realY;
      return this.bind('MouseMove', this.MouseMove);
    },
    endDragging: function() {
      if (!this.dragging) {
        return;
      }
      this.dragging = false;
      this.tween({
        x: this.anchorX,
        y: this.anchorY
      }, 15);
      return this.unbind('MouseMove', this.MouseMove);
    },
    MouseUp: function(e) {
      return this.endDragging();
    },
    MouseMove: function(e) {
      this.ignoreClick = true;
      switch (this.attr('sqdir')) {
        case UP:
          return this.adjustUp(e);
        case RIGHT:
          return this.adjustRight(e);
        case DOWN:
          return this.adjustDown(e);
        case LEFT:
          return this.adjustLeft(e);
      }
    },
    adjustUp: function(e) {
      var totalYDiff, ydiff;

      if (!e.webkitMovementY) {
        return;
      }
      ydiff = e.realY - this.lastY;
      totalYDiff = e.realY - this.dragStartY;
      if (totalYDiff < -this.h || totalYDiff > 0) {
        return;
      }
      if (this.y + ydiff > this.anchorY) {
        return;
      }
      this.lastY = e.realY;
      return this.shift(0, ydiff);
    },
    adjustDown: function(e) {
      var totalYDiff, ydiff;

      if (!e.webkitMovementY) {
        return;
      }
      ydiff = e.realY - this.lastY;
      totalYDiff = e.realY - this.dragStartY;
      if (totalYDiff > this.h || totalYDiff < 0) {
        return;
      }
      if (this.y + ydiff < this.anchorY) {
        return;
      }
      this.lastY = e.realY;
      return this.shift(0, ydiff);
    },
    adjustRight: function(e) {
      if (!e.webkitMovementX) {

      }
    },
    adjustLeft: function(e) {
      if (!e.webkitMovementX) {

      }
    },
    randomizeDirection: function() {
      var dir;

      dir = ~~(Math.random() * LIMIT);
      this.attr('sqdir', dir);
      return this.rotation = dir * 90;
    },
    anchorAt: function(x, y) {
      this.anchorX = x;
      this.anchorY = y;
      return this.attr({
        x: x,
        y: y
      });
    }
  });
  return key;
});
